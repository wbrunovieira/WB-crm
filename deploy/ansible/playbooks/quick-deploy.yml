---
# Quick Deploy - Fast code update without full infrastructure check
#
# Use this for:
#   - Code updates WITHOUT schema changes
#   - Security patches
#   - Bug fixes
#   - UI changes
#
# ‚ö†Ô∏è  DO NOT USE THIS FOR MIGRATIONS!
#     Use deploy-with-migrations.yml instead when:
#     - prisma/migrations/* has new folders
#     - schema.prisma has changes
#
# What it does:
#   1. Git pull
#   2. npm ci
#   3. Prisma generate
#   4. Check for pending migrations (warn only)
#   5. npm run build
#   6. PM2 restart
#
# Usage:
#   ansible-playbook -i inventory/production.yml playbooks/quick-deploy.yml
#
# Time: ~2-3 minutes (vs 5-10 minutes for full deploy)

- name: Quick Deploy - Code Update Only
  hosts: crm_server
  gather_facts: no

  vars:
    app_dir: /opt/wb-crm
    app_name: wb-crm
    github_branch: main

  tasks:
    - name: Display quick deploy info
      debug:
        msg: |
          üöÄ QUICK DEPLOY
          ================
          App: {{ app_name }}
          Branch: {{ github_branch }}

    - name: Pull latest code from GitHub
      raw: |
        cd {{ app_dir }} && \
        git fetch origin && \
        git reset --hard origin/{{ github_branch }} && \
        git log -1 --oneline
      register: git_pull

    - name: Display commit
      debug:
        msg: "Latest commit: {{ git_pull.stdout_lines | last }}"

    - name: Install dependencies
      raw: cd {{ app_dir }} && npm ci --production=false
      register: npm_install

    - name: Update Prisma schema for PostgreSQL
      raw: sed -i 's/provider = "sqlite"/provider = "postgresql"/' {{ app_dir }}/prisma/schema.prisma

    - name: Generate Prisma client
      raw: cd {{ app_dir }} && npx prisma generate

    - name: Check for pending migrations
      raw: cd {{ app_dir }} && npx prisma migrate status 2>&1 | grep -E "(pending|Behind)" || echo "NO_PENDING"
      register: migration_check
      ignore_errors: yes

    - name: Warn about pending migrations
      debug:
        msg: |
          ‚ö†Ô∏è  WARNING: PENDING MIGRATIONS DETECTED
          =========================================
          {{ migration_check.stdout }}

          Consider using deploy-with-migrations.yml instead:
          ansible-playbook -i inventory/production.yml playbooks/deploy-with-migrations.yml
      when: "'NO_PENDING' not in migration_check.stdout and migration_check.stdout | trim != ''"

    - name: Run database migrations (safe apply)
      raw: cd {{ app_dir }} && npx prisma migrate deploy 2>&1
      register: migrations
      ignore_errors: yes

    - name: Check migration result
      debug:
        msg: "{{ 'Migrations: ' + (migrations.stdout_lines | last) if migrations.stdout_lines else 'No migrations output' }}"
      when: migrations.stdout_lines is defined

    - name: Fail on migration error
      fail:
        msg: |
          ‚ùå MIGRATION FAILED
          ===================
          {{ migrations.stdout }}

          ‚ö†Ô∏è  USE deploy-with-migrations.yml FOR SAFER MIGRATION HANDLING:
          ansible-playbook -i inventory/production.yml playbooks/deploy-with-migrations.yml
      when: migrations.rc is defined and migrations.rc != 0 and 'Error' in (migrations.stdout | default(''))

    - name: Build Next.js
      raw: cd {{ app_dir }} && NODE_ENV=production npm run build
      register: build_result

    - name: Restart PM2
      raw: pm2 restart {{ app_name }} && sleep 3 && pm2 status {{ app_name }}
      register: pm2_status

    - name: Display PM2 status
      debug:
        msg: "{{ pm2_status.stdout_lines }}"

    - name: Health check
      raw: curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 || echo "000"
      register: health_check
      retries: 3
      delay: 5
      until: health_check.stdout | trim == "200" or health_check.stdout | trim == "307"

    - name: Deploy result
      debug:
        msg: |
          ‚úÖ QUICK DEPLOY COMPLETE
          ========================
          Commit: {{ git_pull.stdout_lines | last }}
          Health: {{ 'OK' if health_check.stdout | trim in ['200', '307'] else 'FAILED' }}
          URL: https://crm.wbdigitalsolutions.com
