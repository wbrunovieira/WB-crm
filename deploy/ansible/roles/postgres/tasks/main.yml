---
- name: Create database directory
  raw: mkdir -p {{ db_dir }} && chmod 755 {{ db_dir }}
  changed_when: false

- name: Create docker-compose file for PostgreSQL
  raw: |
    cat > {{ db_dir }}/docker-compose.yml << 'COMPOSE'
    version: '3.8'
    services:
      postgres:
        image: postgres:16
        container_name: crm_postgres
        restart: unless-stopped
        environment:
          POSTGRES_DB: {{ db_name }}
          POSTGRES_USER: {{ db_user }}
          POSTGRES_PASSWORD: {{ db_password }}
        ports:
          - "{{ db_port }}:5432"
        volumes:
          - postgres_data:/var/lib/postgresql/data
        healthcheck:
          test: ["CMD-SHELL", "pg_isready -U {{ db_user }} -d {{ db_name }}"]
          interval: 10s
          timeout: 5s
          retries: 5

    volumes:
      postgres_data:
    COMPOSE
  changed_when: false

- name: Check if PostgreSQL container exists
  raw: docker ps -a --filter "name=crm_postgres" --format "{{ '{{' }}.Names{{ '}}' }}" | grep -q crm_postgres && echo "exists" || echo "not exists"
  register: postgres_container
  changed_when: false

- name: Start PostgreSQL container
  raw: cd {{ db_dir }} && docker-compose up -d
  when: "'not exists' in postgres_container.stdout"

- name: Ensure PostgreSQL container is running
  raw: docker ps --filter "name=crm_postgres" --filter "status=running" | grep -q crm_postgres || docker start crm_postgres
  changed_when: false
  ignore_errors: yes

- name: Wait for PostgreSQL to be ready
  raw: |
    for i in $(seq 1 30); do
      docker exec crm_postgres pg_isready -U {{ db_user }} -d {{ db_name }} && exit 0
      sleep 2
    done
    exit 1
  register: pg_ready
  changed_when: false

- name: Display PostgreSQL status
  debug:
    msg: "PostgreSQL is ready on port {{ db_port }}"
