---
- name: Check if Node.js is installed
  raw: which node && node --version || echo "not installed"
  register: node_installed
  changed_when: false

- name: Node.js status
  debug:
    msg: "Node.js: {{ node_installed.stdout_lines | default(['']) | first }}"

- name: Install Node.js 20.x via NodeSource
  raw: |
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt-get install -y nodejs
  when: "'not installed' in node_installed.stdout"

- name: Verify Node.js version
  raw: node --version
  register: node_version_check
  changed_when: false

- name: Display Node.js version
  debug:
    msg: "Node.js version: {{ node_version_check.stdout | trim }}"

- name: Check if PM2 is installed
  raw: which pm2 || echo "not installed"
  register: pm2_installed
  changed_when: false

- name: Install PM2 globally
  raw: npm install -g pm2
  when: "'not installed' in pm2_installed.stdout"

- name: Setup PM2 startup script
  raw: pm2 startup systemd -u root --hp /root 2>/dev/null || true
  changed_when: false
